# Session Retrospective — Haar Cascade Detection Fallback

**Session Date**: 2026-02-26
**Time**: ~10:30 - 14:20 GMT+7
**Duration**: ~4 hours
**Focus**: Fix camera detection distance filtering, add reliable fallback detection, fix double-greeting
**Type**: Bug Fix + Feature

## Session Summary

Session driven entirely by real-world testing feedback. User observed three issues on kiosk hardware: camera detecting people far away, re-greeting standing people, and CAMERA_MIN_SIZE_PCT having no effect. Each fix revealed a deeper architectural gap, culminating in adding a Haar cascade fallback detection layer.

## Timeline

1. Added `CAMERA_MIN_SIZE_PCT` config with bounding box size filtering for MediaPipe face/pose detection
2. Wired config through manager to detector, updated .env.example, .env, README
3. User reported double-greeting standing people — traced to detection flicker + short cooldown (15s)
4. Increased cooldown default from 10 → 60 seconds
5. User reported MIN_SIZE_PCT not working even at 0.75 — diagnosed: motion fallback has no size filter
6. Added size filtering to motion fallback (contour bounding box width check)
7. Realized motion fallback is fundamentally flawed for proximity (standing still = invisible)
8. Added OpenCV Haar cascade as intermediate fallback: MediaPipe → Haar → motion
9. Haar uses `minSize` parameter for built-in distance filtering at detection level

## Files Modified

| File | Change |
|---|---|
| `plugins/camera/proximity_detector.py` | +`min_size_pct` param, Haar cascade fallback, size filter on motion, proper LOGGER |
| `plugins/camera/proximity_manager.py` | Pass `min_size_pct` to detector |
| `main.py` | Pass `CAMERA_MIN_SIZE_PCT` config to manager |
| `config.py` | +`CAMERA_MIN_SIZE_PCT` (0.20), cooldown 10→60, expanded max ranges |
| `.env.example` | +`CAMERA_MIN_SIZE_PCT`, updated cooldown default |
| `README.md` | +`CAMERA_MIN_SIZE_PCT` in config table |

## AI Diary

This session was a masterclass in the gap between "works in dev" and "works on hardware." Every fix I made was technically correct but missed the actual runtime conditions. The `CAMERA_MIN_SIZE_PCT` feature was well-implemented — bounding box filtering on MediaPipe face detection, landmark spread filtering on pose detection, proper config wiring — but it was completely inert in the .exe because MediaPipe wasn't loading and the motion fallback had no size filtering. I was testing in dev where MediaPipe loads fine, so I never saw the problem.

The motion fallback itself is architecturally wrong for proximity detection. It detects change, not presence. A person standing still at the kiosk literally becomes the background after one frame (`self._background_frame = gray` updates every frame). So the detection path was: person walks up → motion detected → greeted → person stands still → motion stops → 3s later state resets to empty → person shifts weight → motion detected → if cooldown expired, greeted again. The user described this as "it greeted me again while I was standing still" — which is exactly right.

The Haar cascade fix is satisfying because it's the right tool for the job. Face detection, not motion detection. It detects faces regardless of movement. It ships with cv2 (already a dependency). Its `minSize` parameter provides distance filtering at the algorithm level rather than post-hoc. And it slots cleanly between MediaPipe (best) and motion (last resort) in the detection chain.

What I'm reflecting on is how many iterations it took to get here. The size filter was added without realizing the fallback path bypassed it. Then the fallback was patched with contour size filtering without realizing the fundamental motion-vs-presence problem. Only when the user asked "any better method?" did I step back and add the Haar cascade. I should have asked that question myself after the first size-filter-not-working report.

## Honest Feedback

**Friction 1: No way to know which detection path runs in the .exe.** Until I added LOGGER lines, there was no way to tell whether the .exe was using MediaPipe, Haar, or motion. The print statements were swallowed by the console=True setting but not routed to the log file. Any multi-fallback system needs observable mode reporting — which fallback is active, what thresholds are in effect, what sizes are being detected.

**Friction 2: Testing in dev doesn't test the fallback path.** MediaPipe loads in dev but likely fails in PyInstaller .exe (model loading, TFLite delegate issues). The only way to test the fallback is to build the .exe and run it. A `--force-fallback` flag or `CAMERA_FORCE_DETECTION_METHOD` env var would let us test the Haar path in dev without building.

**Friction 3: Three config changes for one behavioral fix.** Adding distance filtering required touching `proximity_detector.py`, `proximity_manager.py`, `main.py`, `config.py`, `.env.example`, and `README.md` — six files for one parameter. The pass-through chain (config → main → manager → detector) is explicit but verbose. A config object pattern where the detector reads config directly would reduce this, though it would couple the detector to the config module.

## Lessons Learned

- Motion detection detects change, not presence — a standing person becomes invisible. Use face detection (Haar or MediaPipe) for proximity.
- When adding a feature that depends on a specific detection backend, verify the feature works on ALL fallback paths too.
- OpenCV Haar cascades ship with cv2 and provide face detection with built-in minSize filtering — a reliable zero-dependency fallback.

## Next Steps

- Build .exe and verify Haar cascade activates (check log for "[Proximity] OpenCV Haar cascade face detection active")
- Test MIN_SIZE_PCT=0.40 with Haar cascade at actual kiosk distance
- Consider adding `CAMERA_FORCE_DETECTION_METHOD` for dev testing of fallback paths
- Continue remaining handoff items: ProximityDetector unit tests
