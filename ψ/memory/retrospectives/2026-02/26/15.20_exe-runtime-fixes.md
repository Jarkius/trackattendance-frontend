# Session Retrospective — .exe Runtime Fixes

**Session Date**: 2026-02-26
**Time**: ~14:30 - 15:20 GMT+7
**Duration**: ~50 min
**Focus**: Fix two runtime crashes in the compiled .exe revealed by actual deployment logs
**Type**: Bug Fix

## Session Summary

User shared actual .exe runtime logs revealing two bugs: Haar cascade XML not found inside PyInstaller bundle, and `_background_frame` attribute missing after earlier cleanup. Both were invisible in dev testing. Quick focused fix session.

## Timeline

1. User pasted .exe log showing "Haar cascade failed to load" and `_background_frame` AttributeError
2. Diagnosed Haar cascade: `cv2.data.haarcascades` path doesn't resolve inside PyInstaller `_MEIPASS`
3. Added multi-path cascade discovery: `cv2.data` attr → `cv2` package dir → `_MEIPASS` fallback
4. Updated `TrackAttendance.spec` to bundle `cv2/data/` directory with cascade XMLs
5. Restored `_background_frame` in `__init__` — removed during earlier cleanup when removing motion-related code
6. Verified both fixes in dev, committed and pushed `1130f13`

## Files Modified

| File | Change |
|---|---|
| `plugins/camera/proximity_detector.py` | Multi-path Haar cascade discovery, restored `_background_frame` |
| `TrackAttendance.spec` | Bundle `cv2/data/` for Haar cascade XML |

## AI Diary

This was humbling. Two bugs that were completely invisible in dev — one because `cv2.data.haarcascades` works fine when cv2 is installed normally but not inside a PyInstaller extraction, and one because I deleted an attribute from `__init__` thinking it was only used by the old motion fallback. The motion fallback still exists as a last-resort path, so `_background_frame` is still needed.

The user sharing the actual .exe log was the fastest possible path to diagnosis. The log told the whole story in five lines: MediaPipe failed (expected), Haar failed (unexpected — path issue), then motion fallback crashed on the missing attribute. Without that log, I would have been guessing.

The Haar cascade path fix is defensive but necessary. PyInstaller bundles files into a temp directory (`_MEIPASS`), and package-level path resolution often breaks. The multi-candidate approach — try the standard path, try relative to the cv2 package, try the _MEIPASS path — covers all deployment scenarios. The spec file change to bundle `cv2/data/` ensures the XML is actually present in the extraction.

What I should have done: when I first added the Haar cascade, I should have immediately checked whether it would work in the .exe context. The PyInstaller bundling question should be reflexive for any file-path-dependent feature in this project. The spec file and the feature code should be updated in the same commit.

## Honest Feedback

**Friction 1: Dev-to-exe gap is the recurring theme.** This is the third time in two days that a feature worked in dev but failed in the .exe. MediaPipe, Haar cascade paths, and the deleted attribute — all invisible without actually building and running the exe. A CI step that builds the .exe and runs a smoke test would catch these. Even a simple "start → detect → quit" integration test in the built exe would surface path resolution failures.

**Friction 2: Attribute deletion during refactoring is dangerous without grep.** I removed `_background_frame` from `__init__` but it was still referenced in `_detect_motion`. A simple grep for the attribute name before deletion would have caught this. The lesson: never delete an attribute without searching all references first.

**Friction 3: PyInstaller path resolution is undocumented tribal knowledge.** Every new file dependency (cascade XML, model files, certificates) needs the same pattern: add to spec `datas`, resolve path via `_MEIPASS` at runtime. This pattern should be in CLAUDE.md or a developer guide, not rediscovered each time.

## Lessons Learned

- PyInstaller breaks `cv2.data.haarcascades` path resolution — always try multiple path candidates including `_MEIPASS`
- When bundling a new file dependency, update the .spec file in the same commit as the feature code
- Never delete an attribute from `__init__` without grepping for all references first

## Next Steps

- Rebuild .exe and verify Haar cascade loads (check for "OpenCV Haar cascade active" in log)
- Test face detection with `CAMERA_MIN_SIZE_PCT=0.40` at kiosk distance
- Consider adding PyInstaller path resolution patterns to CLAUDE.md
