# Session Retrospective — Proximity Distance Filtering

**Session Date**: 2026-02-26
**Time**: ~10:30 - 11:20 GMT+7
**Duration**: ~50 min
**Focus**: Fix camera detecting distant people and double-greeting standing people
**Type**: Bug Fix + Feature

## Session Summary

Short continuation session addressing two real-world issues observed during kiosk testing: camera detecting people far from the kiosk (across the room), and re-greeting someone who stands still for more than the cooldown period. Both were found through actual hardware usage, not code review.

## Timeline

1. User reported camera detecting people far from kiosk — added `CAMERA_MIN_SIZE_PCT` config
2. Added bounding box size filtering to face detection (bbox width / frame width >= threshold)
3. Added landmark spread filtering to pose detection (horizontal spread >= threshold)
4. Wired new config through config.py → proximity_manager.py → proximity_detector.py → main.py
5. Updated .env, .env.example, README with new config variable
6. User reported double-greeting when standing still without scanning
7. Traced the root cause: detection flicker + short cooldown (15s) + 3s absence threshold = re-greeting after ~18s
8. Increased cooldown default from 10 → 60 seconds
9. Committed and pushed `d0714ee`

## Files Modified

| File | Change |
|---|---|
| `plugins/camera/proximity_detector.py` | +`min_size_pct` param, bbox/landmark size filtering |
| `plugins/camera/proximity_manager.py` | Pass `min_size_pct` to detector |
| `main.py` | Pass `CAMERA_MIN_SIZE_PCT` config to manager |
| `config.py` | +`CAMERA_MIN_SIZE_PCT` (0.20), cooldown default 10→60 |
| `.env.example` | +`CAMERA_MIN_SIZE_PCT` docs |
| `README.md` | +`CAMERA_MIN_SIZE_PCT` in config table, updated cooldown default |

## AI Diary

This session reinforced something I keep re-learning: real hardware testing reveals things code review never will. Both bugs were invisible in the codebase — the detection logic was "correct" in that it detected people and greeted them. But "correct" and "useful" diverge when the camera can see across a room, or when MediaPipe confidence drops for half a second because someone glanced at their phone.

The distance filtering was straightforward — MediaPipe already returns bounding boxes, so checking size-relative-to-frame was free. The interesting design choice was using landmark spread for pose detection rather than a bounding box (pose doesn't return one). Horizontal spread of all landmarks serves the same purpose: a person far away has landmarks clustered in a small area, a close person spreads across the frame.

The double-greeting diagnosis was more subtle. I had to mentally simulate the timing: greeting fires at T=0, detection flickers at T=10, state resets to empty at T=13 (3s absence), person re-detected at T=16, cooldown check: 16s > 15s cooldown... greet again. The user experienced this as "it greeted me twice while I was just standing there." The fix (60s cooldown) is simple but required understanding the interplay of three timing parameters.

What struck me was how the user's questions kept revealing real gaps. "Does it detect far people?" — yes, and it shouldn't. "Will it double-greet standing people?" — yes, and it shouldn't. "Is the icon aligned with suppression?" (from yesterday) — no, and it should be. Each question came from observing real behavior, and each revealed a legitimate issue. This is the value of a user who actually runs the software on real hardware.

## Honest Feedback

**Friction 1: No distance metric in detection output.** The proximity detector returns a boolean (person detected or not) without any distance/size information. I had to add size filtering inside the detection method rather than exposing it as metadata. A richer detection result (e.g., `{detected: True, size_pct: 0.35, method: "face"}`) would make filtering, logging, and tuning easier without modifying the detector internals.

**Friction 2: Three timing parameters with non-obvious interactions.** `absence_threshold`, `cooldown`, and `scan_busy_seconds` interact in ways that aren't documented. The double-greeting bug happened because the effective "re-greet window" is `cooldown + absence_threshold`, not just `cooldown`. A timing diagram in the code comments or docs would help future maintainers understand these interactions.

**Friction 3: Can't test detection tuning without the camera.** The `min_size_pct` threshold of 0.20 is a guess based on typical kiosk distances. There's no way to test this without setting up the actual camera at the actual venue distance. A debug mode that logs detection sizes (without triggering greetings) would help tune the threshold remotely by reviewing logs.

## Lessons Learned

- Detection flicker + short cooldown = re-greeting. The effective minimum gap between greetings is `cooldown + absence_threshold`, not just cooldown alone.
- Use bounding box size relative to frame as a proxy for distance — it's free when using MediaPipe face detection, and landmark spread works for pose.
- Real hardware testing is irreplaceable for proximity-based features — distance, angles, lighting all affect detection in ways that code review can't predict.

## Next Steps

- Test `CAMERA_MIN_SIZE_PCT=0.20` on actual kiosk hardware — adjust if needed
- Consider adding detection size logging for remote tuning
- Add a timing diagram to proximity_detector.py documenting parameter interactions
- Continue with remaining handoff items: ProximityDetector unit tests, VoicePlayer `is_playing()`
